<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="styles/style.css">
    <link rel="stylesheet" href="styles/profile_style.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Golos+Text:wght@400..900&display=swap" rel="stylesheet">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Pacifico&display=swap" rel="stylesheet">
    <title>Profile</title>
</head>

<script>
    document.addEventListener("DOMContentLoaded", async () => {
        try {
            // Ask backend who is logged in
            const response = await fetch("https://hlas-backend.onrender.com/me", {
                credentials: "include" // IMPORTANT: sends cookies
            });

            if (!response.ok) {
                // Not logged in â†’ redirect to login
                window.location.href = "login.html";
                return;
            }

            const data = await response.json();

            // Display username
            const welcome = document.getElementById("username");
            if (welcome) welcome.textContent = data.email;

            // Display access level (role)
            const accessLevel = document.getElementById("access-level");
            if (accessLevel) accessLevel.textContent = data.role.toUpperCase();

            // Optional: also set username-display and email section
            const emailField = document.getElementById("email");
            if (emailField) emailField.textContent = data.email;

        } catch (err) {
            console.error("Error:", err);
            window.location.href = "login.html";
        }
    });

    // LOGOUT BUTTON
    document.addEventListener("DOMContentLoaded", () => {
        const logoutBtn = document.getElementById("logout-button");

        if (logoutBtn) {
            logoutBtn.addEventListener("click", () => {
                // Remove local data
                localStorage.removeItem("loggedInUser");

                // Also remove cookie by redirecting to server logout endpoint
                // (We will add /logout on backend if needed)
                window.location.href = "login.html";
            });
        }
    });
</script>

<body class="background">
    <div class="whole-page">
        <div class="header">

            <a href="index.html">
                <img src="site_images/logo_v2.png" alt="Logo" class="logo">
            </a>
            <div class="nav-links">
                <div class="left">
                    <a href="index.html">Home</a>
                    <a href="browse.html">Browse</a>
                    <a href="about.html">About</a>
                    <a href="request.html">Contact</a>
                    <button onclick="toggleSearch()">
                        <a><img src="site_images/magniglass.png" alt="magnifying glass" class="search-icon"></a>
                    </button>
                    <div id="searchForm" class="search-container">
                        <input type="text" placeholder="Search..." class="search-input">
                        <button type="submit" class="search-submit">Go</button>
                    </div>
                </div>
                <div class="right">
                    <a href="profile.html">
                        <img src="site_images/Default_pfp.png" alt="Profile" class="profile-icon">
                    </a>
                </div>
            </div>
        </div>
        <div class="main-section">
            <div class="profile-section">
                <div class="profile-info">
                    <h2>Welcome back, <strong id="username">[Username]</strong>!</h2>
                    <div class="prof-img-container">
                        <img src="site_images/Default_pfp.png" alt="Profile Picture" class="profile-img"
                            id="profile-picture">
                        <button class="edit-profile-img" id="edit-profile-img">Edit Profile Image</button>
                    </div>
                    <p class="username">Username:
                    <p id="username-display">User123abc</p>
                    </p>
                    <p class="email">Email:
                    <p id="email">abc123@placeholder.com</p>
                    </p>
                    <p class="access-level">Access Level:
                    <p><span id="access-level">Loading...</span></p>
                    </p>

                    <button class="edit-profile-info" id="edit-profile-info">Edit Profile Info</button>
                </div>
                <div class="other-stuff">
                    <div class="extra-prof-stuff">
                        <p>You can now comment!</p>
                        <a href="testStorage.html" class="extra-buttons" id="go-to-browse">Go to Browse Page</a>

                    </div>
                    <div class="extra-prof-stuff">
                        <button id="logout-button" class="logout-btn">Log Out</button>

                    </div>


                </div>

            </div>


        </div>
        <div class="footer">
            <div class="nav-links">
                <a href="profile.html">Back to Top</a>
                <a href="about.html">About</a>
                <a href="request.html">Contact</a>
            </div>
        </div>
    </div>
</body>

<script>
    function toggleSearch() {
        const searchForm = document.getElementById('searchForm');
        searchForm.classList.toggle('active');
    }
    // Enable search redirect from other pages
    document.addEventListener('DOMContentLoaded', () => {
        const searchForm = document.getElementById('searchForm');
        if (!searchForm) return; // safety check

        const searchInput = searchForm.querySelector('.search-input');
        const searchButton = searchForm.querySelector('.search-submit');

        // Helper to handle the redirect
        function handleSearch() {
            const query = searchInput.value.trim();
            if (query) {
                // Redirect to browse page with query
                window.location.href = `browse.html?search=${encodeURIComponent(query)}`;
            } else {
                // Go to browse page with no filters
                window.location.href = `browse.html`;
            }
        }

        // When button is clicked
        searchButton.addEventListener('click', (e) => {
            e.preventDefault();
            handleSearch();
        });

        // When pressing Enter
        searchInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                handleSearch();
            }
        });
    });
</script>

</html>